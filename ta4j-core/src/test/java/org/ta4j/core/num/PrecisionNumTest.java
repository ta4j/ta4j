/*******************************************************************************
 *   The MIT License (MIT)
 *
 *   Copyright (c) 2014-2017 Marc de Verdelhan, 2017-2018 Ta4j Organization 
 *   & respective authors (see AUTHORS)
 *
 *   Permission is hereby granted, free of charge, to any person obtaining a copy of
 *   this software and associated documentation files (the "Software"), to deal in
 *   the Software without restriction, including without limitation the rights to
 *   use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 *   the Software, and to permit persons to whom the Software is furnished to do so,
 *   subject to the following conditions:
 *
 *   The above copyright notice and this permission notice shall be included in all
 *   copies or substantial portions of the Software.
 *
 *   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 *   FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 *   COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 *   IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 *   CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *******************************************************************************/
package org.ta4j.core.num;

import java.math.BigDecimal;
import java.time.Duration;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.function.Function;

import org.junit.Test;
import org.ta4j.core.Bar;
import org.ta4j.core.BaseBar;
import org.ta4j.core.BaseTimeSeries;
import org.ta4j.core.Indicator;
import org.ta4j.core.TimeSeries;
import org.ta4j.core.indicators.RSIIndicator;
import org.ta4j.core.indicators.helpers.ClosePriceIndicator;

import static org.junit.Assert.assertFalse;
import static org.ta4j.core.TestUtils.assertNumEquals;
import static org.ta4j.core.TestUtils.assertIndicatorEquals;
import static org.ta4j.core.TestUtils.assertIndicatorNotEquals;
import static org.junit.Assert.assertEquals;

public class PrecisionNumTest {

    private static final int NUMBARS = 10000;

    // 120 digit precision
    private static final String SUPER_PRECISION_STRING =
            "1.234567890" + // 10
            "1234567890" + // 20
            "1234567890" + // 30
            "1234567890" + // 40
            "1234567890" + // 50
            "1234567890" + // 60
            "1234567890" + // 70
            "1234567890" + // 80
            "1234567890" + // 90
            "1234567890" + // 100
            "1234567890" + // 110
            "1234567890"; // 120
    // 120 digit precision
    private static final String SUPER_PRECISION_LARGE_STRING =
            "1234567890" + // 10
            "1234567890" + // 20
            "1234567890" + // 30
            "1234567890" + // 40
            "1234567890" + // 50
            "1234567890" + // 60
            "1234567890" + // 70
            "1234567890" + // 80
            "1234567890" + // 90
            "1234567890" + // 100
            "1234567890" + // 110
            "1234567890"; // 120
    private static final Num FIRST_SUPER_PRECISION_NUM = PrecisionNum.valueOf(SUPER_PRECISION_STRING);

    // override the auto-precision based on length of SUPER_PRECISION_STRING by passing a precision to valueOf()
    private Function<Number, Num> superPrecisionFunc = (number -> PrecisionNum.valueOf(number.toString(), 256));
    // auto-set precision based on length of SUPER_PRECISION_STRING (120)
    private Function<Number, Num> precisionFunc = PrecisionNum::valueOf;
    private Function<Number, Num> precision32Func = (number -> PrecisionNum.valueOf(number.toString(), 32));
    private Function<Number, Num> doubleFunc = DoubleNum::valueOf;
    private Function<Number, Num> lowPrecisionFunc = (number -> PrecisionNum.valueOf(number.toString(), 3));

    private TimeSeries superPrecisionSeries;
    private TimeSeries precisionSeries;
    private TimeSeries precision32Series;
    private TimeSeries doubleSeries;
    private TimeSeries lowPrecisionSeries;

    private Indicator<Num> superPrecisionIndicator;
    private Indicator<Num> precisionIndicator;
    private Indicator<Num> precision32Indicator;
    private Indicator<Num> doubleIndicator;
    private Indicator<Num> lowPrecisionIndicator;

    @Test(expected = ArithmeticException.class)
    public void testPowOverflowExponent() {
        Num x = PrecisionNum.valueOf("2");
        Num n = PrecisionNum.valueOf(SUPER_PRECISION_LARGE_STRING);
        assertNumEquals("1", x.pow(n));
    }

    @Test
    public void testPowLargeBase() {
        Num x = PrecisionNum.valueOf(SUPER_PRECISION_STRING);
        Num n = PrecisionNum.valueOf("512");
        Num result = x.pow(n);
        assertNumEquals(PrecisionNum.valueOf("71724632698264595311439425390811606219342673848.40061398197558400628535301224325643216058951634134487681508791576999627245777743886595731790545842366554761960764715298199175003491698577211286777266293829613857304790203141652841341965933919391594071804439505157490302430762773157180552969960522864095823082873441680807544918991203869348555299690458903865314435725800329292241572202898890243426149619074137233197293302558727876625465252035629952605534054248733352420143658565066825787684456965525734073507885806971213010152950953654336699292262932953296818721212820449820087344151656553177810720848835123990382300462154832295028583939839900512827625370164949144406661074671569820237108586270109431448109725094893131604249607451409922082653728543854496396085264748558023019737395311212340360924693854937492419450793593992183367210721950721381943684242634254267400343216332964422191330212627426946750415808407451123635427594645644829139081263025663166449233830222395125965438688245956773051668954571764834787203488753789108695378538886023689560714116918022258848041890900525402045484908021088098956392705393648816334126286164670658196920876541746432442368484775047048336388959152008469612610584131056943937561048957655818367691474410289022960295903253223484219140744105021893314255674202528364264971733602723443247961598369626755987284596037693366051313253442210258917559938679001386510782542351720309935500204291971383329665310816783662223230741497715533660376607702599335320686934477100036316607503565709183224194452544482682157346389551618149788052982778263236272476905335766202314127219300308224367109649214042457366793163136717995263099845284751466528878753079679456805381707808425091170324238310245614582822777661960647728893224684239510947849549999386589805013849784343854816212984720327971396206232545120686020900405944658823610816219789490259115849498395366028624420990103520950536225025996704419109373472529379133359223742608560572841165359031562907848230885938315068983677251328318911290657387978396217029547478808009017473148996904347293564050136917528522105313100612688859303686497022403089051911372142347953251014056605807376169918491694191567441959393476814016152068596443448558253646960203048105664040908539871889250791552334558606753614826083762699843535700395488738647562623908978295635823367311979483067474111468003904327788301732675169331629848690771472842124195106786326512607393633937764585857746909874410642073978298541390431488618063910282819045304267722577211697286932606367027036680702519143095779950649400347119612072379276782470368544025487100201644627710884878510105626903621533987853041076831596330605218915452869201604048613348328260498207027258025250477541181237422773961761733047112034975540213155120014243023057843103021257187750987957463062957168946581184741684722395833973858344111672960119737555033259115241865898127616946899507053036159481091258336986967712688100897215319834337447010542503708858920241306781818719336935927022853728497752805880138837947492715738726531567831212451551324406301181773314597089534725932224083142885521596333897058966683368625094602483074384313333911167306376561226126712693720249468634377090821262603344638495465466546380399792171168775254215610829748728604184082987187063135462742752627701005737351331343179237284337919378626151957593948564065400513780731884034320984929258796803252730905279269744716069237700798534740641496155903976171633381609869131921677426693877442587613876079591014512141977868925380972912403072938138196803938303235427548262656666993630676816079370020478962939975616292241158774911227836302784103308764011516377263074607062509464683283310359618606106008996898035602081312217719381426579760477614300332648603405637798236372279224609513114683678536042433992526895914271776656220516368406360889050985405297222308107526933171234263864355602013860999646736093408836176096010537394340213094467442727061261552271985379571074217362009758549607870335184435217564352313837607103804736120936420874550683241557558724604839123919506072391316610686441850421669141132770996086286923309489606193046869099797262233309494865371884040923009566204125699497949712717515698452397583421466568479545168828385627792568134505545837794995050959018878882427732826278471594311875950448846660385679052070526246578869381712948016927397324963319711436702392156145631385531264399070737477846065364623957889922051516521475034593057693553341645030787917655352479422739827474611058673188166200655205044923426578822028995290890845723087114020293908178710668616852700631830978715734297163803293895760725365421808228118977647816351601499634070591653810033765208634582908609410932353937151488624797102481050189609687586468945302508907864665093457335327907705265481427235437389637492544059041061815395216988687388339809013014222415122198602757140818479498906141512870134273845866771028368258986267424544724510666856701219992623159708546389849674355465652858607479866018617869992305618315246808789943934597249122926036420128442313351327466248694260021123815364773348972265568466817317080133940441632528296115865614643148602621376212013537004099118041684340245215395448133045576690687257312643353584385414961935682105738160698460119275275573408698062073385982177842258985820937136940681108813125380323007296424909562618640955731396012030297757395915612693394245087761824456923034029286382818400506389668494585720475871155289285616591441479171658667957463227415553973813139138077555504335524609314570584295536909624097430278875135654302868882014322620689277095528120027100106420166737092822121468150623614009952034096107234847625604628673275103930651277363106354381902021336342982763309521429963288503558242398737264174889187451154289346715177695078515428604566827946693600296057322786438595605757051437537658458446832081449201324626180791778945951196155827898246998917170707388393812524699153369083630794221151317573954046249870199221454556718885158053874402328404477342326398655078530448722922183347450757500110629884421352442523313667136043495771147756350570609079630285158796398132958734811322194498163481479746655516176929580802776851037530010249055883003850638630146317729644701082030389142274323935167093463997902314060559933615358994228113250814924391501467141287273143033537694676250446364140591558275618348503194358571495755335114952183729191024351010274104084077389763778052696460622687935432102982491454796118820783012653494748411435130476578547431640023608350055076971650745505682793268366244283190484548152899336154240770050347494905997728715885787035742867936275991964603670444189541842417761030566110497438171204655614865191894056672046781651117288729444339057506907250086241546518737370331150610729969045305153722110139889624767828083464954779342265566680981053793311179755468325049864449801364571355439464309562956381992020106028747149509099514194849103715974725071600563967172553731794978313120099744527021774460544795787755915179949237323623596648169990050724578022192161823603950343804775641061217772641451201921259086676412466423970500349829316631991129761242128353242935743687676839663898440266932076905774917956099347121023541774976862198194787015693557125924188840819940688052218988436863675083453182656189236842417927081487222457795483025608617046200326918340609796998542501131707588205835452814232280487227930466378321160857466396712737027882813223154296556187093368009591843652712905091927304456554730547087390788612178885034627177491896782066511411003981621217903987973703916561537783384629424739746137097941135153849050250201809188508240994657729934028308207060521091027745479377263578422510750977490696806063041299728592670546005026214313773643980850333073790026814392147449023570834928091084491108094046388649930893468973054693121537729071236987928747093401630007356752435992257198407288975417769039814185089193755372572109906670437804214933043140450788584938469284603633498806240506821477646617697782450289088286792547810765996504760798925642291579595719226295153813427842793337917083272969361039695637775821799497789877665506555537868154272646841141008713651746738383295269278129112364934571554261522424596530593566532383265399733702508097308750582905385663036054017942948916395837104151603594905278871570557217627320395695028407195566153702177053185374182982426133316237967426478661367620141513886111245224238534501319053071243771336003617837537806808680710263973328313425855634077342024183192779269164685295709824418373692490578233306811877776400364382406905442702262891741012299322662644438058230759129758719236609996337983697138597324214924030133055489862444169242754427552232812278288025194543278555217632392750591113980334272784788699014048026268434783005931614928370040720278176080863026413085935697763284406853347365403601724873870732157955440377536729150795618664380891345989494809237453583437272454156579143833022321962841784027484667497460400082885627987768722107528665028161669654391437028790045498398109702652972454633004741280108636822044776903509270618034307976497559259286867376734619082819167505513966586380516505417295031414419855855965167309145399821296895330442929715867281910812788364540801800336979903474266157743586783962924490141034870523989694110899423509680194652484156390730750340990930691085310975880765545883191749266594641486022823685846683535061022258903141753722141703894903869272074925282892690416085919552686332350903328399805087723735377084136015428212861816321430780125253466522214030241137180963715359603926087724848804290704517448177145940164802930406146736706975254933298392080792336871916790381621613895118237440060735791295552730516609726465835390388966389664779652757969828388195068265395707832995526104366558469710974155788695407633235540856912282588898907628809566865898279981796385991088662125237360662570551477205676695804435731005135563585276987998248514887354439772991788613915529609986094788229393538087020518849046806600482053848581744708426684375887025650779307130033185235338912025156747246767411198879726563782687322425506394929697135958862217930680285545595306159448904208181773894223622238678342086347953999802587014247668202559329656643764834851242210851165601499047750386389661487279671229690977120711895516279492621091028376880697795674659731617411396068297541509357846792136121568196841287586205953142846786968373694263018931302895357254700191216478420535370733501911817633888871748875276606038816723895661235774624673038829559166023189904885052412054694717593861836250613303500717055772464865588309094229411608348141845860623405710148314979226897721032943751612449159121804723451560298031111089250086247941072592954407428782111173749193173607723490383182366697233150539259706730072124586962011145732336313222192702722162321226919525442262678056746056774865280301480557946374627756262315060563178665708400180768051837141121618654879957420616900167773148349727776897219954912855486929992046245497840965454867621973364824363376921546748866179548789499573692116797133683217604285142072540777653486331265825048801768337880077660561967043880008614856418723955124445194386426222938834374394239809548659890515191353646461737267901933251447477600189286931225692703990782103557127032514897061521639432116426292289158150966785535513599620790764947113719541707226142516585881244178696159368145453873584074425851675571359107520201406604646928729802062349877350034310746477862403674368842648540005266753850453323232906673598752323779320282691243158065315177307008513595161462704688029248982509608925354822345423961472926679336335212120943178232660766399514062500645614078588560146372192803507965927799542420407394851750546451873326382115558871963138955488271049137091376432548358576252575371933302173149014121414811214354976474813886765380145534090119828088060750867769710335253343282174148151683596345063238268356712079255739698555775701451620314319401222066692800751080824534869408497519698997634393553057807606693836882807518365634533711424045716453091713282690280986082107480239377232318566260615657861673726148599990874617070200855675138101007571137431140277671028488934687955509291116755086911502467217693065567594120098366890172546644798558066967708728506055771503967360480822306976992676586130056933183604260617366191616505329366358448827342202655324699025683788303752675645260484038093883057364713764502246951883909083072626869681242267215772490611190124027309369642911246133462435596030565938755104915408317469707052284802115796381673853810599811443112964783168652849311991405873959779813078024363134777828623037973280877808188115131595432968823044791244713281926328458658224346655275227486450398886637864723764744893178293805750220856919004285548583018229154586380189325662786312907429770819483463150156997051777645774230280349058738901484873562469682578734148814815893893147003545418044700583851489968989438756359366962465947152848086826055861895878129490297289265026240205775639649306973020953149495651408421644634090427529866907795389264811520138438183395447020457132585162467118701612557958572432219899067420712007606456639805277075541229852505100988771579758651379831508380661427144044026998783242874953352761645891413634534785332140635530178499696207124934303797241141628195378537957859426947210550292972435069145916887537239502982178012587029825834730034731067407007450594920042685232424352873104291060590894877762928502681347858843035189885071627310340744298338309755631610486907700018702919985939397147549961012561933240320226484505282491460365278420197168176316553226817835938489475566865430798257472618417498791161682994507566904182229416893876636070961261752394141257072530462607021453382753301560804762500964833889864254883905700160677728388707508796672753975594236441382761324664614053679071692492077138659170508793797487707949762474765056287936384028406253158660438643340493572253817636616239629751957348481908370128315690397578333551403691630434321525174777725180877745274577063053583726800111164081425123645674606511619861376349008898529598954902233968654875789254985660728761981238635649570657230258939110741410593255182296687456020001395991931581139489082603029401293438936485137878212764025270584340014106908324540525818068380867005796869827641209343664844237822224474895587081496618644466871306689547407458326814850007568237427696546896137080156855350550721647067599973876582054982058714654496604310087989144493337299677151841679851419603670890175457105932913121314650043234250120615283099045401941241525901033159858076408716805652195493982275944160625764085270539808023077633936347944265538553925240533238330826075905338893692992081861268182471797809552892353916011299112954030650228678189316139588772369773042620302209538588920131304319306652435371890963627565155474909120318974398897350127461365522129987561629841366895820576001976172595432781104023152211431879072693614669684832367880475505849942890912447671227338107944603938244521176926853518666993807560450764879557679792762153551642198035524324341999562995663485815395162642233261543879592267877423585805427040553768080979682120587391513351350405786410577293133215606586649059384373198956464671796602196687796584528888600643445909000499920614456606499557164328179811396852144290608651905493455527201979462574342065674389884055088959525411430743145501226914308817817759264375628797426216105530994953090254524249816288970698415202391316132062518467964361711520844623028857166736743692276133453378050963048308324538938333706860255883271276485801814871522491420133241727530870636207348154285969313699001294150583971351836702325081289110631625596119367397846156655594310661517394873029281956950497014605722521174794933962251907606207215339766931771685905858812601048579960304734980429678140460042487037359864429805027027803305826415470155885658065612241768103005682132694357885884592030854008481473292052333760338123327615534693104721287676428134721744467268599294429305621259230760272748691629122556988767058643256486786811899407590736156590750721437089826889572150271991960483422658835832791792492138425633772834709575473876135728135831911913441312210674697905453575439384767672382346163285417087279163797734749905879613172671891154176144732948207018025690553556496291702646126203993019044527747894530116476653041820897984832332372257562708711195019923884905516214960580400492574965374631588071972911202559860595828146375202770983199188261281838484051667623510072382149598459975894073292633296443611768188618150921288161021024504846240576366523449852652897376316595297531230895061839913821661525198618977306595158362045026755879204613956737194473228065350112021842763968808048715717393356562421913376244126406716878475371108505151728796404702227400896258984812173653731690246001212918924072725194929420592069540314727499406102374821573733861582865036167128290769623623600045011018417407978205461450899948732718931145895168073416642205128900873565371656541308427174758231157582858565584855007790488858850183638748636270850509575688947148099286225211400701741567433368125391314322356911086683313738346165426961615186222808995339475582278979064832048841364867676175218330697186774864896313542386271038767192692258741061792959115568966330938208447567523723130067764524878533137009491844046663730506602040019564733397807333039588416996516719571853067806877363969432261591931730523252724366035759671669062611294325004920573939171527749135566959666169462482617062233220585208226546239221952975633119887237216508240163457541183903279802827410527224486910395821172292019544103155952891397033103580931163369308432148699728438324650927711457058307355056258683280153935646326331432653630474707821269839101114770195391362047855578555783981065561811463580957557108424478817261619908443809684018182971602600030189754953037197032554894646686803056473157959615936271501614326856133152521483744881262944315378727139250763549407374759781943188898403527132952346819810734080983204115285838388130431772295582909801627065252651993646641315393863385915834886072593802811274033256937959822428778948847978763103153264378103489195395154565786928328263172082804906187630803520835695139008193282979505815857232258669589915663598061073855126269288385574578112302659911811942885210703392600480053053761440158595882213821753849469813415177152546922018818920942586227481625579319776072540015000357318450542643072770846694675602365388587739742360221012112670467804796504760182598014123505476784815965270565212566850356884598575135011259892038076767462816232960491044905503356830166756102727069445841618232262554001769950884750670263485307479255352975708668729207226366489120525642231402032391326668729273046884873577836876332544364283135790130928222170750507343244936873998313243288191629627772329946007792441294415605090112950849763290815093957281867619469253126580930444627167180541225817109183851313119162409822242635955306743749694060093013560543976378982035308703160264261984136726353507452925896008138852495304009406730767671091680038413459479040580409168809817535680453954739133902604889258682212005668925784567569456967885332730099182069128594103194343450012785517447339960801964922794207319677277856909464587594920349622149678705596410021428132021297065399298530577928345717695666761013473604884284907599047674885836453885652583072308480835458583809589981084162479399290508418983372560050514058719662301278068918279737608174189623308326115203894454489950666310885970576617549698816689789909503794814105573519471085032498595738679181095747727147449789487279683121995332296463375875018556178814463594074244642144429192944426457770878540899136633017150668872925907591106914208027005231313713390506426960606651031667575315581934006320771540772142747594541741071534260342344891597743225552298578878445573094775554862094706552845147850319972810737412491509997830382603357390341238916549871668912070134447045889050364386546081314962964923015485407645454331110987932682487175470725667553641699737521859072517055520468914755026433485870626521461636990510871780381807553606852232389468975138683694126185840993286605949391489631644617825828727876171070264955492111211274786468440166912670471508003897715557832733164434292256318482770681617315918680155366055927453215053528232483424274301162382833292065691477699637866599588363844089490772927582575438004035360302007347405686130501983888939434097048494836537214146129464172410431908058680055030839652306454307444339821181810092731305460760616922783760108575475666839837107865220254309956846091927484497665961744937356919750905712797370842993681174966214077366283264006161458119041099797150002387602770197566267831090208520551814578960938972187506176103779567520239534310398185031954209178645984331904853371376533889621548519187491294189897431405213893435587435878428138085721753968591636519602035494287714127603386553234625888082095482964424572322596040853229116859425805885131231216327862136020751610704677295073805304752140246643425519750351467390444908238801528027104975821563843833588194252902625531078632950546546064971628237834944234692804750153038485073128281447256700674321228813751837193626397278958949251993340390391861721397929796140876169444596125948388968377399790956573495806000298979845868417545329070950999889154360910518561300577570069463071378857476873975588444629331802634177700256220348689366318463000739673349548861884168840929387226915168674639047918777131888001746162335644724598319086232884338077714215476528586139356896069350933747662546842798256333228439483030281013776964632448838236940916074763864296489179061666545052082973066294032528284642743645352579121919411660978648369390863806417833132601024288572579918074332462467587166049589331877398268097934427751311492920769752076765829628946434905857472011388897338006815320740233107173965366969517910843090176597591752209138790674915416347718960132590945412413000307499734255065079752461486689736180758727659123436238658590971616384551457272125988542338318077885750227520439211258655379478294103532513820231122916233026269867269257660528003382506591178281336883938397752349863389153375427407648931279260085530928190165869231996261934790366398135814215775883227591561436982204944854257246072370071013076809564448812054813001061204816173003624289425091425731728663439519239731792781211400603586228578291938812182622162768709336389875801972747515108576910833429678199145073190753570492862005778999482060408005393779375359300169986977950236310611479900981465422329180054249998109723372982645463520408681343379941392606011456766961164359143500741965477831369033598123796361005301453546207510307304862746575818890600302618666359420143884552792532962261944919927371464084046950912764778048454041131511700898822019324337478982174256185200573701912403409885040812813659945802559196362329707210035093444570902026677327550769797883947565613455896160095954082653684355616036015220924613275920642383321751380617729263384009500769556041503338062397022305668403009330102017428680924677418801472183609597098072204883496017197617894573562847284836719273306626151572662911397081693473647444140871791407914476628525574112654340728755314992944712228450939815804230416009829518481795532491083903762340384544668099581143519550226038364067654044342212534325791503929019653589259406695695098825579504652986359207949614010136266604379109954440418126212956047221136061218651603133323247132258436449742624821289332778300799347418959202694997357603692471135981119107881641066074088643334765769783794584516420015732449824082934442631966586017696731999876552435277999649764678113524788686029775021274821255861174783179217556168704480969463789328047606646594184464807382714570961585540558242165930057250075400312868033272792607062111448899004676373440561817936909565993102313725768065255241978253810727757418662789171161558436245775569548188851958318311973285798194164055503898617540264557747068155803672393684530148342379064184949603266001531542224696823822042757203129182675879563388752452722462371141195951632659415756729562734485574392547572434320584495411034206811127445381445424681576529748828630198085322578852422522596302225796213699814963204086539266867769816924870897327186700940460297824655668187570857482225533381166134383938497053241592631742873844646200987995952291879848355886246363927287188741080252263647330757638664220804303618229797270654396116677483440495606545074135067561283637148686176028876792345861528797516002647222622275048230181568811953335842107885803783601924359114177358952229588841809344376892266781512467378499887347323278444952854832191941828092081370965727821868486642322987195126963479192900605714180686836247678166443209741790285623047119997268246074237108601254726534446067616982759590615067804271720072966140236613581544376478501702902975359794138337385491958778481942812238200878023833904175087415407176549976288645701231028561516846014272690430581797931689639878363350135742170534511566306090220618936852402716358826511361812466637885278370597460420376427601170239672032842138622030386396001748406245199015650060571315665998048377346203764454103848385420850707434208773421227427727951073923364239814495090740875523910943897799884067782891212229433955704915653461928151759305307672106108315829022926780945476759421463523205732796671136201641558191085558735545857531694833655385058057639648802943185418770392346363281218575732776760600164008649732325959246817836200420069591030781190653447375231932427686045982231274088620428511765562820315990313124480700232978984019910225934112770834392272422203581586859056892515135541886366057718015991062740348545976913130504936275199911909297665371742386024487822690801781763368446060853849756303095013319905529247189656295046626400731393521305604858683860212218237289816710168550002782470282822656934536849671505336838629734898552771872003073371539923985895595881269466277971812925123442136097550925140548058890385258455007764861377077097956096289553602194598701856511603579704046866325516976421879312716259056771846076029811733777273245268691847415190311422124424080863344420423501410593995161820723716310654535915372811377078546000603741874862728479358818336680499396613873126944597507952965984674139951521480961155413545032381464494202297254115964488619315106686630676629700711765541931261368470375525755032282804579173170378926797724024757063005873610841019429176648912908498912598783489285006103476761157355425594173893848588334412011375638312313516763618938719128049452865798456491440372221998214273247542363477035789892943557121319737646392028953941355554697496946935594547666052910187898996394485513647004386273519934546957730424278323654929669388782513792874356307219152080461740564799625094211118157041442700810119773959659471301107133212768700373469503199440678925009168620880342585105532054602685231561733503864337738938898307052582293040617882356553139783816223418224844352525211151364303519303871546840969003678337561259881130878369849256719736209400527331372973448158910005636998299828511729463932708441321532474139072826162824557283810305876349199670322262650447184536531823579257096301843228594961409093302777136677260071778639809834563623461955195703591090046282225145868226767481164907823411870229751730251520184716397872538161410601318469575883971673537460156158308558735575397273492471442944985216267872214464048472525873692732052125266282556876671021462210447162155011204385986185048410134851278790866210299366232074662823269711639112186765771594454554735797139690327205484781287784059011251448488079369336171800175289715749525218942010611953457887702677288339724396716330406716941056339384343375053337118774052534826986650122580493448643218317776015364596793305403327631377155811255131964769421301664966008178321974658905324851238526838946420912670024613272753835467856588348137916634610010638446437302570359870971020769385850964662127448227356789601462586632629323275673944877492167890358678918539309473340701761694863915003083764730169906561855227475882313794696689973220529352498289114697410738908425425020056903946467577225901866864617605146983852186333338502661166147257447128806654551650640510096964884694450904627243835914565069023430229329340147290414047562463943648642717668171737562986079588355875427516974964298589277849816558498559207714749401039361101267147365361832425851676058847000440635208434839435444098813677903183917445495793546800179642239551561065236168283816580286389839210580086711010346253251249619455881302128682143003444950300793038268780094865946224228714913731873715793900852196609349200854827486998102987535820181306071931962767926778157855149305091546462976156399131208976696229559544190209776664905644848268282689067741569104517898179767265577852944819922563739565104479771935808392420331999721451145852527024536886896118044439068962612022086906618453379207616690404440367438009513395140903065442560787879538784438536316400262466810567000631751734542161622064547113434716109086785292755382463353786673268492059623304804336218449951805932724235297971136874557501402303956829969778237594694330904143845593682911556077811459305945339748786665753558002539311632008877507139041023117830296162863898652622716902564720791913860156997537652871178149705033296436528743815479938065040160845765226922611718908944260558836070471457989769868385553396634856289683372831210363300600568344933999056473215384022799561473237396436620759000663000039002549788062524864554231141660990393210178837132696442353540364729367328129723489478188788484586379834756929581942414365154692133766025978368626969598448648629911747675138842278528119181065031660003663724859603249401326972753720843775610860911630529984947649433621039372127012207629830846738597244295835897973784798855562194486645842703800446421083302813236460629516997023124190758361166524034358243140326783846195526137952026095166220888594701032786591771777646885187276650107818739225143989289380299121216145598912475105187807148223070733767548165048823341307296917494527179083958535299257434212449989838224245658722771615626709752356236547233114986159648218338277595677048413682824851200811400350501717657966456269387876783449733631958454073197377807569630052584153027800869928707597740445197520778907777833997767749450124821959913629822605794722798044595463904679168556629356503033723348908330936789175358080332940163529699631970765498098506767829329318798776390512115878437590435702945037024668593906895397495842028766952277757463213538975851474764585830716285980708243273876271232624220841783390594062322010375067945634857245430989531438804691596904243094120417038424735644428157171710480116171013253064134194679839387360600302814270800288789704833934039258781431336601151258224419417720836921459378822972857368080567836642406668958626768900835423077983523279046311517233121861472513108000224927075155318209679953405045037788792816716409957248584744650536451676811443485888729658570818062621043143753129761687365899600141933448804612442539986265629453911910172439596404676588451683833184499804237448915426861457786087724286106448242807887968772569907900026871032951265111101169305721733790058511914294448121025242434799741698134775930779206640772127707813944393570222857080105063827630278964709590355585046356275948818287583411234082274241598053583901306803540597735404120905797099987769845678122750962798563071612963877802507538676574262244457113154874204663467446952100940537717349387480109562335741655843597551592359160877627376392650702009647546940327192722415830346882357534210313829304450338512258140767205031658338320896404903781883347621397636598149127659667605406923335440133469651127162300278502461908791603013896748456806533637931148835191606859729880571723385900748694428624924802820112188710662138582937777143066023718896085888789508329844829724496046016354117141952476198959700009433120488539325878759615621832042501284566408283966322621614018135183406962929929020091951503046605400608296700591104789647166420433591944118793851554336647155198076329072924619993019915677507902066594177448364885638335029629567664951678127119074885449121589015055987900174858692782338018176724754686145817282760043804339597651126470129973617513362613555861736279865855101956130094707868128884723549929157420859423337249635177731835011506222999556917130604511853951085077620477311131094044189024735225321996312054918400866452976598412960333598581280757587499924354713627790586693743365241718624675026633271798205404487932010087514913328911738306270543466844116840908515849795671346744978832708921356553386673746339153458834918228681290904808048964006273378048731384015770567847149281687037898653991164126205497356545044969824684174702168901978511468617183777335133797162232559957792289684962855376437940881968187239853911417177560862341191917196719347998353816753779852732215771427722961036101959279947596475762391446772217424052374557821819773891222650135004380880959284538148599946501698040082796209234142282228136639994546503435314653786552171697411910177527260387476854770419333570447253999730502904091020886753526594275833906541671964952816807439055405611242567246402220875932523653185675665457085870224523570299892809148186221158420248003547343712505319747547912343127160353662693564632322601386076541597512272702659289126029784718481689041690804716774795776159553238068751241313479631587919903007938453829712571066661989755018723972521404010190554490097408858569819921149472653103626640226909918995180277893547707216316476181334273507359870812640458809089609165613063692029467946227855953381813330321507705967419584481449994560900398602952773004032680287426700475365596364988367687180336043601268786109640780716178853975519351743654630357868687106817331297616244079040276458090706785905131934527867088484408206956843536833630487288414027444695631195000138932295049867441109446306955557879349604423675678688380422230472654012650076775688201275997494217956515748230961651041146815152629841633891302858374737556122329814661146506845190432533774585795671922163240402804721129174109565201376739816791547815307972717098655253744943909890828608613260304489271280014132913602066931592583468250173349218862787548111828696353092025254123069831467976001574988389736320054492567514222016115477035973432261859302687575445974586138078033331103955668557643840394012099809028010698886053006403640310268025898110093468979198650803329855174305964408424895556822683518934521294090570228615014705341962916316470849774647217595360878015080958149321213503058946126313234049799118088559767693291796433828536774823768341544389670956335180559597478617264148942794778250582786017202896899576626792406868516031133403366356235057659596936746969971824643671379010640081729189730125957046574448437649349896092711795525885257978869616787023518320620321711070073593240194457618035912763563987546882654445096643553942509051352713308827387291288541347470756487718083418449763444780116343721848422030306507425074397817121972268473062563109973913283792852472444145720040882177040384894669997556569241501869471627067286197250449757080238047594188331273809395546130839093281121669874133352170683819589260089337335615599177501834305515816259299665350465055692361908987459791484547701757408397894726263517158709187191454908566856525868496092394639646753449413177707219597741746842630314946657049899416184938786836598990185125559915216527505221660120090461166663797693349331192956274888671354434247491517873084179223277963566274220320364082181977265614230407441880397355336271334737245056207681428651441009625108977423706473503121069978344222925013807631055991797838051208562541380151104618175699227659183714827034409577868835859452986220636701929555373485512586189449123879975286647570016519274589745376172586911158620777887675077521753221856054223035866047554034796156884492098122884473084232870374093636773971877154614352431220610478098658802450851849155403180594752791026180872484853662986575926707588611335101164665688594753463259280084260534030677145625187530614283822254859918648899248210078636122075554432599188824040346443587239366426593360727642941213116964514666087628868904976695965234030008118649327589793714719599527575802667232679687586730057263714722030903503585766495914415474756639144596546733895236259494478883214901756738960384626257735395883539189646683292350746563374304408291409090282763825562401262003904503958995957259319727643099804101089073653473931632989113344973226450377613318583588922019221105561310877712590441924691126223067075776079445593596173454720796359754027737650964789410115943500430332858810760236288486360309664837895615079996878422088427851919490539008978230316604073904229050100808156835483432031433172920311196379696591390744530169603228582135704272387325004143734192140037077863240715151582956557515442215628386118509398896831150422440357295453539415007899901855055690016506395311133680263289959700796017387692240550352246641952288110799855705110889240227295606135098244231506050313027047127425956924288678506048795702378684759027670000704326091944941331422326055262003882549726196309813780940104759533322456682916425030218049531582289044958463866813170571929008498504732125713119300910117642097066439809013598476339725715113294243734476963998859547102978608039714885289540167194538523231185312394146866173185999496302766069490380716835776937073285783093326483024238018620972575886260876071065021747785914129931998038313142785740473684003814339338038228084235320087054233439876908252013006463663998359324705076216527269245564780211858149064117189472803964451187581504225602920126750333049032570770406206448063866202385169262039739340083688520725998515700580820804079031221035922530108750045716798005701996434213232397620963564574762289527077919202578863563082041377432789804764818010340812557371142654139608250318987809983939953927872677212227485103353163770081533565008616325186579074712621584546555104969504573943041541528124194046275552014093283947634749761597343574246651121142842637154476390224635686008012358502124722950919857222966219135013141373803984495727449417095959529163744495259458895144488881690181857653047923609934999364593098686615603099760450390330725942854207537776864326298697052832783528635064072324359035558035198390333359175993409177927423743389098213571637671724239133992161942646670876629307579787390011382725584260063648735606220570766347214701255342865433947664213315829309448307935006200791789866879704169154200713372349279400534495463698091311421321473395874398868543912072913645405162156502346463903063964293337714538935195421966781514000971849741525504825841350000001592034427085425304811374066477724730875772748523515973141163946858282332037136788205699217183371339469342710283021365290868674840397656343905043673512168249475782652887581465354453944908314694772122983025475152437706802051496549060032233091528764850554129069991345415963012261379643059667487306689175344432279002184597809878513566572799348664274566048727794292474971723660220265999848229303333965115482294270020254349205248982975678143600988957942416466328848489150656488919841015643613263175599436676138775605514928468689724089309003188800728867250958435599639906155194539735129256401434718735672836238505612882253526558030370177624906207895771332451973679498074403363775272718785553900610122814125307688054557310780792309106016277147166574557547191463954114856710304116801532425719732486095706872358745516336312511916392899541949660117079089375457981915147281780575665165482363645703511950946150957358861163557522609794263292800679447138070841670964696206134016528159305255913084278756351380155194989370033013471406480033390459915193541641300890762626698748446814820731370013053326947541305394331068959128142789082433415226829102252191066714729769871033644380454205584412312762118064369779239262855675486047438087148315702834026158064124542362817171142026811881854387044595730061233320850135399947239537030395293785282491807382572374447095906302500798935135510492464996952128016652198342970309917029508159771963813663101769194363697841474593125525671698996077179410091454987703006958484072563907276858662390308279956042034787506072587356053086890147043804444387211406758797114311387183514465089930942657564260417153816572350296935348805268210480018634867558775146911113252075943666503881886990117051993697947772807115854617715743748673555705983790717186579735807250605040948091836523089240081369530587294839021340177631766912073408628719433916319148098592494952992159993207128944507862628697505822258151137293189768076887596005770360183389186160493347318527474281107267324131221440649581222553015637351133575397150649192979236814309895117040712870905688226676592211272329692200342335592976823224781106553033604177664342791012887587181598493798219093066803470239708596805224099231444184716116648709226387450364523222737024642394828959057101118959110818499728827911089041820448306125542063653354198563704072080638279556154906908823429949441331070059635531027165293618644545527616094765434088810038611897255912780192507688091337882657922971629374919964647673472145104620912037355925086832357464126053576649546429597530506024413885993762684307964129712876243155501211480734356087909770624637567116470279136307179198655266086183405346867483926062439916480905826290635406949446276747019273489959172965077279924248859799222524671419264727394504405109745405848797178817070138583083582737994849933863933420530475722768131158137143373247597672214127617592630895941606528562925913512754083153835216068306502879320993073903494410692261145611180230232639487366426639862308839696671114829849037219118629647599852000791738224803852515838596734848616175520522102467981416543880017535544194578361461112563592251740799779032384879512567708955313690298331202295285708693405001260232362899927315324675001876465249434749804745017476354708839470781868565175297741939344462352146888465988515174540026851597801136105033652771360484322708211780161493022130898289829841451496486244508828911802874065842497422429322496989706336994603571534537515543977032873964871504563779074977996700009976832479638460892911642194040996437710660971852185654270634402225636874884238130995583861961794109906248565976374838098598004865446740390858686281326928470819923614805966280262858839275038062612138414801793114095833028575629273602757483767788105568265043648130308510941396200790882501519798702612841590827154207703001329408450477372314193283189647841667139113818513937755298603016360558192898943570908932650277338334434128154523044738132272287011485329335360920704109160226979473203929279619819935697595050596160821878040782002974043902095383379535650230474467622330457205659920804162899627469947542194704961264095836321826955624509822081151628865484286035191268943897683929418646406533731661509187680420113671515857470372919860022933537539929892413561264833786222072611146306329692850503436559718141958973433119188221920159107417434825289170670184832212350015617541418739541731033081020470913240665951336061861711233326809593216837828759817840375655684034298153776494562809144771221416447674400444703938688987957513084846937366138213237524442909313952198985141523969516278499580077277022366451087338727019743941140899350320181893370865796606656115616939172931428763301079933923389531536402291694974399575835116836606297521184136915849775478874478780789562732411176294652077154725270922345955478841297286197064840306808036855448789569489776974452123861726825185982052970252685682099206388904405261337848925017121203720417103472671169609587943303696979785894432648444073065213659302102834585455740099240068358008561065685307747333498352185718027942660007033120826891986371300734046285197731909728682237406405162438643349046578640173722361946125894321105308598791155950254585348743015282161347255348423371459145736857267007184735722567920715365860138028277141570663574346498265614378686188865331834770411987300943986272531572349528119533142589394807402915488124688289189965507350005194624043380636464430052484306025498872880918182288112821813209399942404834262815175213924252891167778281704700210317296811317056995854163774526822168671278882341617801915125242193669110788315074717306426410185922530773669908300348121163618305542541017472370747806152584325088529308467512464307456037217507746113111097065331231829837212962797616223449480424223907474795233298644416151779053957916893290125383848402462255807825940137156563742953672787041291152947858439882939548096742164110134078040455502614967015237713047374088712956318566152863150552807492487340829911446688950138413427910560051846807221266470530859527127163566147468711666242170949808570012804298721081527312250970187035198350892397110813765491304683056100623250209324296740759417013505575423169594586968966157126233513917684681880976588808096372092140099893969219318374442616516794627651794471877372890613775049107777326782706568994664612979452835817247527328623616340860276077651043029921925865632337386719827463374817958717795505872545780735161829267366170472854342803532047182466391905440850075252693994401743628447697078122247419386591646377106686844330943944037661513640811940255348977921553574368977328395444691293624360859491435049152801025992293786044040937213204862904260543199361002722599038982519236164515516721894496849444404882480083836033216868278754065144306594130860694391781068791587058187839748061302348644278340928461847294828280029882051559939918744985151506065661293488594343748091343775240354559488795251118218999509514313423979312960207252560515115176867581456062071671012843691281455877570634342346305501313861916489028761256677282828249701038613340683442297121346776362005005781322435926700107158263156091731688985443141222551104498671252849322060224795567306174150862579748314379594071062198095637249890576710562659448671856429278294121072433372673089671503971635604925106517426926920418880298185125035564529075780716803766076427484712386571634934066715125050431374677856757298696524064949002236272688438506697242747893035459139342890577545068158753340478738864411900732649359890548797594118771154403611866497665605555482527960979540256213895516071800342252221850021716844566340691534162343475019296201306369052561305591984245672014882888376092096245141025719969928237619372536913401202009932374349189774659441031546145676654649560324579587099107858335816639231725400116159407358515621107067307801826087158979333024195541329993104804424465267175337468116426886242180197930430022371881828328880178456228805605624321527646608506817116087087608050404198090698637813937916428730804122741573592788771481797550621957520444319557136607145747481318573092742581242944287528464624259985642835954228121177192988185637500570188232510587243861096391467951950938081201943962668257588788236331764473325665142617543529663885011663394979620506059953501296389465716100468495071918247061580418074164949740367449285814520111605367120306652946984477407189187490534063421065026435545788186468238648112585194871858014582748912460060094440168065397866922457441513671427249166170512091104964730867645289076061158790262280224119249152827810433591060775391884585692599107617943907278575332594330187179988432044017980243464156097569194703863562988685343552120285484372492981041875899533527803354938729272747017237189871899207384020006317613848845831405191669721194655591336476789128005379010367018056696401741148141036142024935274951934089318302375521467178056425813620041323668236639239762226481145953466468169459712506532836949697323705372485746564307955997350195661520223539689843270369143758629724897090815743187698669344714794900197390011449547058588770011927533678346564029234561927395528447079415728319096421916125855521991948610962109340957953290808305735708822493498363260910974959374881614423105188501452011571533532608683810788277679591694750262665062985106998708624849200685124132860952942568882955969297876223682778386248435814289614334967253266394222562020297849830904749329392514950770765072710216167478772341671623403611025558662584601496752561696691849766302590196174252734877173577984195319491263037857849161610162760352905120416976828972746631272964631129454520019418904383518857563319516655259207433935453335975322543024138702738602803909201751456438041838095445689639925664649692715844794835428430140636968593189764715742286843592730762592754049065185015651589505153523097349518292469772227284839822911511754361690461057436057583454575664864822188233383485429300150196335811253386821991717901942584208793156108553577070249172590029603772750647527914090417829718671386446003469172153404215217497113130432866492344881265925148559256813229667211842031927370545549714660174912741798272043671601792774607888447229044069944829444246825626537128163918729769492580978863371621971803911669672841610299766411110895457092489873970214271490177605876893160201597717735510943677865626119790697046442222536876610206045201408796146836102544600564125781962392936214499338459359559152131365015432882338841009479527205523987177304717072281559653332473935977433231353189112138013659384831452140385956860521516727589032517246946034791026148322828321658514068867300876999483708561320022076984868926917574388811451050368787807365262922574555436892084157749603903191044965614816395012356870446851266320803799209652958808631413802887316277274893704264125984867497938150965485130838406468181116584348030587923569929177315275819006297784695658642688470344213758441551196261816838791648000151813215247298697587977788718185055236300230660929253839105454672485214427004659782666029390656463281478181097910634192377401770322576732493215868357583695294506813459272427919179244969153006858105546626994952994118512047866545600603720129535789583806893424229359461506966179435777684139551941285748492503838690406576231065942326232323388698156740362812679469454746753871485346804081886663332329629310883025811697122390019262395667393323418865792974069454115736816570341438172416065024554067697706844158034130732682598811936975321622131381727198320435696428509608884836607440042006676048179534855815898886140278846510987372433811459876887312244758340090019964351146646616658091189354177963593471486435883462900717296050603095209609121689827821294657418020414739199744871025814439999592834098722725252085868097234279356163678142850063541814227162282755146350693556938925330412296392608017244822509107510620887730842428101198857191806211371188331945564716908167644418681474340837707765351287903960306861965481213087366750076635371392459871010857265698918627860281073093054835555780359165771415415117507399267685145105771033718771239247757807917216798912961693399062719749713879302294670843542696406210167624164612701928416662979939300719642112005084156134071130717266560533670081171474315638608301931405904072051971739484041761355099268045577733779987310573044093686756955348686282814580425831015737639168840296309238097828008568808773578402534544646865452991033412501025938195471274977071388295293416285313903508023496340500193328492837989184855581660984204168751129062967798762709213952222957082368220707705459831288892010690911730568309354999021416297384441955947094052200672742591572703767122688974872724593260912062553007721243726186361807789843393107921137445763069508401328337410367717244861406209940359719740958448087381996353394193480025877799137098361510635542680922461564672409812016048473221735471617696983339173595316611411375395565344292858152816377388751930897564896438084131816006542501295146921453755396001056693891973895236365621757892131675030074949020728626366226970634053265102441192403436865482861443384703411366823095196363882301332057142882156283987519668520399256990572380282410802726145851791685766747879434862779407474063269557512688078043994058489690584266443550619454784305442242011153429453940061474583365943228366707960540181772238160302379258496973826814721738874228581962658686445766387203456593246110852807553255299343067769916112022869190088597784834689896839445556927589984437429012115055742543437190161821656315128546500993027320015873753186566045905001772996581830686969439788436105993130083067095132074423339521529387351820823945342491610585851604521648062257944799223278609446412386830852487239602110058828206456016196736471418539598248248725002521839357904527542437907445923844605650211341196777326692193569413486865136020046450163279295961582873605923894775733070871931146128238218400367164701899840042589803382808052141872439623975679571822083554434843746949417956257853722734061369350160827853269072719129538302125673231321594347396014146236207502696954751061865859821735721353840926886333098007009777551457896460093375406891665394573897857939221671173772666198043239631806218058565344554774991313353732831569389036043611724975912407596281564075515612246144419874698332685962160007697353147606297090619296078763058809214271622095032339999261887583667187452480539487371068742456212957712638822062745546809033849063904736014958088058889085481780659272985270700110936650030234022911945207951183040939855010391819488530303847655160818118605089028809996000563204483492094613523565466385929747117110485701599923669720045180840494492836866270635488053853327889196886046269916840669476190635797174400080945731333001698521336145940724829849828296016392508100384913468448320594221128099259987334118132492804796300804047037889859327726909400309036748054977396652414175814908194396863059306540681103998025349049930030805184720790029468836571142836829326544355314180465081186417660260898212461283730454276791768722013490341607033773288538899411994222566894329392583649659933595870314953495848433543008989346809963878558157698426203147032269879171691672102370668130214258204446328619991878990832050051960045940166629526684088371353802983927895861161793298669189110778040751701982824796864565322902636958323455791498885665073884185620757415057794662517579922320013690141588732188216763439499030184402951971620816882770900141922098712053428153076083122784949266931201302108980597634901486766731322569443858295332813632794468117935918349107307311164902074015602674065061564124605013870281638587135926474145251928329929631520215356339768198580755932281923588246167902437521966071105424837509218960839627916384931721063727576131156266526711199385195082954405404674693308775391117485546506232849968863272659798304315269019942866949349642477667458071333209127530241091685388024628310336161477227832376101831920575694202746128500298302567503573051399711866521545285446617627443655198261384201987345641286531651356087216931994710460737968447733559625130026136708005444292286090556176520448336787929683570143989000945502102723408740715316427672240354554913894420276954219198595194305202881154252757230667359554420843276070686289424438388186919553200859774911275306673828734302553506267901381698448303097689793101951544395259369484597439133901353203455320140847125337484951346662263448170407377261906597277384902594295756919894960458979047439219104601284438233743652371227641320760799143635841138156663987984548636442097818781175499211815846455063808479885492342440248149302214659088891015477303424581142388133882066840946593129099154139064144069560876790275060890238157269979442345720867603064806238697269912295878913346857066598003623509259834860748861297924697488943575118109107180275365929692107174674209129313061797315042377960450437811884148774833904408008405971841024455085896820097000918249733754291449155962968949828021720624417946082946373805352705663684007216940082092490734442031850530394573565070033812184668832931114251952448132832056454083869604890832988921788129492517215070569378311929742251310118182611999875825563475358563584621499916954930033838454954982360714410988152819130983664684003861700530774466942306927990245460244432590490708185986150774572253808925233145255866696042983171373846321780576849798057297720804109121888650111155953054006995213199582085259648612376450949811191573743701177714886622101445539402835899565521827253033017976214422690895253041179341156349232867536018969151754212930784594205628445991543304529392702308077253199525492568377437643649627066633557784835614501501518088093187826592939631490630897357612910797312539195909351468484588713221748514531684908948434340594277520959918543120005772459273553003496378255248862128562858005862833649683754192865723564710523296820853408960678225371001098869546222554921365783037916648325160042388678243132714804777476118262313975544586103652427451610999561841501081311638747209969603761727749382246441523226299941490181317055356723374259902235638849432890007396920024949591775926585039423380979095855268022571780575682420381239219714783870374504228832491907400268771218071861214020443631665879994140813162347740818595166532757835095760721705989368409864335333459008443094735203522217922130455352295676908059030193768005065655868276190789560261285107808282712364920061731139238359270115538024954437984349110674966488610400509524566269818902579325072615107486449355151785288854383955812031608661831579518093702651017831107707709132996231500342513082954049441284033514228874941441923193360100773063293944357565306589882641136793476360020086779037731336508049575882816235609390801688741315459378612447644610206222693384314377129003724525078315265049910879899658472164419913424489774297799396785246252194763277880981523950688538195808836123376001902555264712179091543670372498615190439058245696091427804215521655689652704652312579196108171914526390694433178780548847887106395674648550007054285269313115661337131347520777031142588388334233628574126627771153998191649994620394782805826571416621172599003923665507261000622018083836672094439893060715883326240489267208481299765369796067217598292828047602307860438546725590968579713125740715619304628623756305195426325666814636804137468928047480715966154163777745987752815708196890386549264930442969867890561558965760674033552216316194699339993810742728227176639160608755545425466718514825380197057543139910841115699800522530617867932766341464440605367186118979461634987559766477097150693854266212627274174700679573005459136343142637482740441927716139649724215011757775318923853900863240258196069250939177175857449446666182706118570237680583028537137481517554092977886892942905377514401164576924029090325116174608160895660348618777992969471846254169972139874635677398916747088679404341867447562533245284007953208356642357184969931661133821991185718568688141268124051850839389609309729812099995851429706797163974230712549642885866019715824631465866095160153594376902305813647769340417828523046006396184486955814266744515057616952307877672554260439975612008219627687559859632650946156250334278304755744566033488186206799453471044654755405639961042776498662138136952595764078490906821659367351118398907486369103927523563863917253060412358661100196851378678808410447155992161694769619341192670674475301279114862491638675454286562347262460143557842844303598427138064829651235376153353920298216569662997216237925961703307239265008905962326088580888738774160551585919820195331846412780369849175952900476453260045669304322606946631532944093247015305697110653138093403329803993857122417366893082149858685722233726214327163973982926845020257909599638834197449099967319504337379063459627777206587423423290952571197091692417867937989192596717567676202184024437611280274727568906571393066166442073305964287979578640416330681942874365873446376130625084803297366374869614343297219940157759442997269759306386486528774347578896721759840534357946161463158797543751361749793845697818989965622238236306669225031991258390988243805109332046039101056866211588502834376648499948963007901412076383446596918715635798945763829667966082343763596430028052323367950085225585570978693794341954637579048185676145793167880846302979568155452447609393165219184694556547568563049833746616099084178104706579783956643885189182687944337355411829160776115749158426216371198975733337236000622677975532062859889663984220245029614083499062056412119563695415969672881171577315074977121612997201641494418163124665189863336720090047080384520380024989801688508796247196538755854267152990400356333966457448513513783490093356751626757780404302378718179023586666350805807933966952201429976981679276486187406234131642651827515619233568745746525384050433560149042824676641735456001136242027792933334945829622487781427056361761844835076641985169632599306812063071543550215650354087431074151444189330477914230371357520786575009901912486722028463720021676369386704731297397149687396044449279815084721424308311965770758507105755433087416077040541251678966524883733630056691812581998235914062755215346902830701892895934337167958633033925506277564778413019449268398092637819117919226144175987747886367302787462644684084678362717935369253359416877885443271411157903461506741566545412586156404855949968935042796404405451243990144056514443020139022186704960181336090357132472405537467161045309505652674100300676167988881542412218718624389121"), result);
        assertEquals(60975, ((BigDecimal) result.getDelegate()).precision());
        assertEquals(60975, ((PrecisionNum) result).getMathContext().getPrecision());
    }

    @Test
    public void precisionNumTest() {
        init();
        test();
    }

    private void init() {
        List<Bar> superPrecisionBarList = new ArrayList<>();
        List<Bar> precisionBarList = new ArrayList<>();
        List<Bar> precision32BarList = new ArrayList<>();
        List<Bar> doubleBarList = new ArrayList<>();
        List<Bar> lowPrecisionBarList = new ArrayList<>();
        Duration timePeriod = Duration.ofDays(1);
        ZonedDateTime endTime = ZonedDateTime.now();
        Bar bar;
        double[] deltas = { 20.8, 30.1, -15.3, 10.2, -16.7, -9.8 };
        Num superPrecisionNum = FIRST_SUPER_PRECISION_NUM;
        for (int i = 0; i < NUMBARS; i++) {
            bar = new BaseBar(endTime, superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum
                    .toString(), "0", superPrecisionFunc);
            superPrecisionBarList.add(bar);
            bar = new BaseBar(endTime, superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum
                    .toString(), "0", precisionFunc);
            precisionBarList.add(bar);
            bar = new BaseBar(endTime, superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum
                    .toString(), "0", precision32Func);
            precision32BarList.add(bar);
            bar = new BaseBar(endTime, superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum
                    .toString(), "0", doubleFunc);
            doubleBarList.add(bar);
            bar = new BaseBar(endTime, superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum.toString(), superPrecisionNum
                    .toString(), "0", lowPrecisionFunc);
            lowPrecisionBarList.add(bar);
            endTime = endTime.plus(timePeriod);
            superPrecisionNum = superPrecisionNum.plus(PrecisionNum.valueOf(deltas[i % 6]));
        }
        superPrecisionSeries = new BaseTimeSeries.SeriesBuilder()
                .withName("superPrecision").withNumTypeOf(superPrecisionFunc).withBars(superPrecisionBarList).build();
        precisionSeries = new BaseTimeSeries.SeriesBuilder()
                .withName("precision").withNumTypeOf(precisionFunc).withBars(precisionBarList).build();
        precision32Series = new BaseTimeSeries.SeriesBuilder()
                .withName("precision32").withNumTypeOf(precision32Func).withBars(precision32BarList).build();
        doubleSeries = new BaseTimeSeries.SeriesBuilder()
                .withName("double").withNumTypeOf(doubleFunc).withBars(doubleBarList).build();
        lowPrecisionSeries = new BaseTimeSeries.SeriesBuilder()
                .withName("lowPrecision").withNumTypeOf(lowPrecisionFunc).withBars(lowPrecisionBarList).build();
    }

    public void test() {
        Num num = superPrecisionFunc.apply(new BigDecimal(SUPER_PRECISION_STRING));
        // get the max precision from the MathContext
        assertEquals(256, ((PrecisionNum) num).getMathContext().getPrecision());
        // get the auto precision from the delegate
        assertEquals(120, ((BigDecimal) num.getDelegate()).precision());

        assertEquals(120, ((BigDecimal) FIRST_SUPER_PRECISION_NUM.getDelegate()).precision());
        assertEquals(120, (((PrecisionNum) FIRST_SUPER_PRECISION_NUM).getMathContext().getPrecision()));
        assertEquals(120, ((BigDecimal) superPrecisionSeries.getBar(0).getClosePrice().getDelegate()).precision());
        assertEquals(120, ((BigDecimal) precisionSeries.getBar(0).getClosePrice().getDelegate()).precision());
        assertEquals(17, (new BigDecimal(doubleSeries.getBar(0).getClosePrice().toString())).precision());
        assertEquals(3, (new BigDecimal(lowPrecisionSeries.getBar(0).getClosePrice().toString())).precision());

        assertNumEquals(PrecisionNum.valueOf("1.23456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"),
                superPrecisionSeries.getBar(0).getClosePrice());
        assertNumEquals(PrecisionNum.valueOf("1.23456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"),
                precisionSeries.getBar(0).getClosePrice());
        assertNumEquals(PrecisionNum.valueOf("1.2345678901234567890123456789012"),
                precision32Series.getBar(0).getClosePrice());
        assertNumEquals(PrecisionNum.valueOf("1.2345678901234567"),
                PrecisionNum.valueOf(doubleSeries.getBar(0).getClosePrice().toString()));
        assertNumEquals(PrecisionNum.valueOf("1.23"),
                lowPrecisionSeries.getBar(0).getClosePrice());

        Indicator<Num> superPrecisionClose = new ClosePriceIndicator(superPrecisionSeries);
        Indicator<Num> precisionClose = new ClosePriceIndicator(precisionSeries);
        Indicator<Num> precision32Close = new ClosePriceIndicator(precision32Series);
        Indicator<Num> doubleClose = new ClosePriceIndicator(doubleSeries);
        Indicator<Num> lowPrecisionClose = new ClosePriceIndicator(lowPrecisionSeries);

        superPrecisionIndicator = new RSIIndicator(superPrecisionClose, 200);
        precisionIndicator = new RSIIndicator(precisionClose, 200);
        precision32Indicator = new RSIIndicator(precision32Close, 200);
        doubleIndicator = new RSIIndicator(doubleClose, 200);
        lowPrecisionIndicator = new RSIIndicator(lowPrecisionClose, 200);

        calculateSuperPrecision();
        calculatePrecision();
        calculatePrecision32();
        calculateDouble();
        calculateLowPrecision();

        // accuracies relative to SuperPrecision
        assertIndicatorEquals(superPrecisionIndicator, precisionIndicator,
                PrecisionNum.valueOf("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"));
        assertIndicatorNotEquals(superPrecisionIndicator, precisionIndicator,
                PrecisionNum.valueOf("0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"));
        assertIndicatorEquals(superPrecisionIndicator, precision32Indicator,
                PrecisionNum.valueOf("0.0000000000000000000000000001"));
        assertIndicatorNotEquals(superPrecisionIndicator, precision32Indicator,
                PrecisionNum.valueOf("0.00000000000000000000000000001"));
        assertIndicatorEquals(superPrecisionIndicator, doubleIndicator,
                PrecisionNum.valueOf("0.000000000001"));
        assertIndicatorNotEquals(superPrecisionIndicator, doubleIndicator,
                PrecisionNum.valueOf("0.0000000000001"));
        assertIndicatorEquals(superPrecisionIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.5"));
        assertIndicatorNotEquals(superPrecisionIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.4"));
        // accuracies relative to Precision
        assertIndicatorEquals(precisionIndicator, precision32Indicator,
                PrecisionNum.valueOf("0.0000000000000000000000000001"));
        assertIndicatorNotEquals(precisionIndicator, precision32Indicator,
                PrecisionNum.valueOf("0.00000000000000000000000000001"));
        assertIndicatorEquals(precisionIndicator, doubleIndicator,
                PrecisionNum.valueOf("0.000000000001"));
        assertIndicatorNotEquals(precisionIndicator, doubleIndicator,
                PrecisionNum.valueOf("0.0000000000001"));
        assertIndicatorEquals(precisionIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.5"));
        assertIndicatorNotEquals(precisionIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.4"));
        // accuracies relative to Precision32
        assertIndicatorEquals(precision32Indicator, doubleIndicator,
                PrecisionNum.valueOf("0.000000000001"));
        assertIndicatorNotEquals(precision32Indicator, doubleIndicator,
                PrecisionNum.valueOf("0.0000000000001"));
        assertIndicatorEquals(precision32Indicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.5"));
        assertIndicatorNotEquals(precision32Indicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.4"));
        // accuracies relative to Double
        assertIndicatorEquals(doubleIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.5"));
        assertIndicatorNotEquals(doubleIndicator, lowPrecisionIndicator,
                PrecisionNum.valueOf("3.4"));

        // This helps for doing a memory snapshot
        //Thread.sleep(1000000);
    }

    // use separate methods for each of these for memory/CPU profiling

    private void calculateSuperPrecision() {
        Indicator<Num> indicator = superPrecisionIndicator;
        for (int i = indicator.getTimeSeries().getBeginIndex(); i < indicator.getTimeSeries().getEndIndex(); i++) {
            indicator.getValue(i);
        }
    }

    private void calculatePrecision() {
        Indicator<Num> indicator = precisionIndicator;
        for (int i = indicator.getTimeSeries().getBeginIndex(); i < indicator.getTimeSeries().getEndIndex(); i++) {
            indicator.getValue(i);
        }
    }

    private void calculatePrecision32() {
        Indicator<Num> indicator = precision32Indicator;
        for (int i = indicator.getTimeSeries().getBeginIndex(); i < indicator.getTimeSeries().getEndIndex(); i++) {
            indicator.getValue(i);
        }
    }

    private void calculateDouble() {
        Indicator<Num> indicator = doubleIndicator;
        for (int i = indicator.getTimeSeries().getBeginIndex(); i < indicator.getTimeSeries().getEndIndex(); i++) {
            indicator.getValue(i);
        }
    }

    private void calculateLowPrecision() {
        Indicator<Num> indicator = lowPrecisionIndicator;
        for (int i = indicator.getTimeSeries().getBeginIndex(); i < indicator.getTimeSeries().getEndIndex(); i++) {
            indicator.getValue(i);
        }
    }

    @Test(expected = NumberFormatException.class)
    public void testValueOfForFloatNaNShouldThrowNumberFormatException() {
        PrecisionNum.valueOf(Float.NaN);
    }

    @Test(expected = NumberFormatException.class)
    public void testValueOfForDoubleNaNShouldThrowNumberFormatException() {
        PrecisionNum.valueOf(Double.NaN);
    }

    @Test
    public void testEqualsPrecisionNumWithDoubleNum() {
        final DoubleNum doubleNum = DoubleNum.valueOf(3.0);

        final PrecisionNum precisionNum = PrecisionNum.valueOf(3.0);

        assertFalse(precisionNum.equals(doubleNum));
    }

}
